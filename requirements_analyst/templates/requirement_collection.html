<!-- requirement_collection.html - 需求采集页面 -->
{% extends "base.html" %}

{% block title %}{{ project.name }} - 需求采集{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">项目</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                <li class="breadcrumb-item active">需求采集</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-list-alt me-2"></i>需求采集</h2>
            <div>
                <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#csvImportModal">
                    <i class="fas fa-file-import me-1"></i>CSV导入
                </button>
                <button class="btn btn-outline-success me-2" onclick="exportRequirementsCSV()">
                    <i class="fas fa-file-export me-1"></i>CSV导出
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRequirementModal">
                    <i class="fas fa-plus me-1"></i>添加需求
                </button>
                            </div>
                        </div>
        <p class="text-muted">"听清楚" - 全面收集和记录原始需求</p>
                        </div>
                    </div>
                    
<div class="row">
    <div class="col-12">
        <div class="card">
                        <div class="card-header">
                <h5 class="mb-0">需求列表</h5>
                        </div>
                        <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标题</th>
                                <th>类型</th>
                                <th>优先级</th>
                                <th>状态</th>
                                <th>ROI</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="requirementsBody">
                            <tr><td colspan="8" class="text-center">加载中...</td></tr>
                        </tbody>
                    </table>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加需求模态框 -->
<div class="modal fade" id="addRequirementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加需求</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="requirementForm">
                    <!-- 原有的添加需求表单内容 -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="requirementTitle" class="form-label">需求标题 *</label>
                                <input type="text" class="form-control" id="requirementTitle" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="requirementCategory" class="form-label">需求类型 *</label>
                                <select class="form-select" id="requirementCategory" required>
                                    <option value="functional">功能需求</option>
                                    <option value="non-functional">非功能需求</option>
                                    <option value="business">业务需求</option>
                                    <option value="user">用户需求</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 九要素字段 -->
                    <div class="mb-3">
                        <label for="requirementScenario" class="form-label">场景描述 *</label>
                        <textarea class="form-control" id="requirementScenario" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="requirementProblem" class="form-label">解决的问题 *</label>
                        <textarea class="form-control" id="requirementProblem" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="currentSolution" class="form-label">当前解决方案</label>
                        <textarea class="form-control" id="currentSolution" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="requirementGoal" class="form-label">目标 *</label>
                        <textarea class="form-control" id="requirementGoal" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expectedSolution" class="form-label">预期解决方案</label>
                        <textarea class="form-control" id="expectedSolution" rows="2"></textarea>
                    </div>
                    
                    <!-- 其他字段 -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="requirementSource" class="form-label">需求来源</label>
                                <select class="form-select" id="requirementSource">
                                    <option value="">请选择干系人</option>
                                    {% for stakeholder in stakeholders %}
                                    <option value="{{ stakeholder.name }}">{{ stakeholder.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="requirementPriority" class="form-label">优先级</label>
                                <select class="form-select" id="requirementPriority">
                                    <option value="low">低</option>
                                    <option value="medium" selected>中</option>
                                    <option value="high">高</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="targetUserGroup" class="form-label">目标用户群体</label>
                        <input type="text" class="form-control" id="targetUserGroup">
                    </div>
                    
                    <div class="mb-3">
                        <label for="requirementCriteria" class="form-label">验收标准</label>
                        <textarea class="form-control" id="requirementCriteria" rows="2"></textarea>
                    </div>
                    
                    <!-- 价值评估部分 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">价值评估</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">预估业务价值: <span id="businessValueDisplay">5分</span></label>
                                        <input type="range" class="form-range" id="estimatedBusinessValue" min="1" max="10" value="5">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">预估用户价值: <span id="userValueDisplay">5分</span></label>
                                        <input type="range" class="form-range" id="estimatedUserValue" min="1" max="10" value="5">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">预估技术价值: <span id="technicalValueDisplay">5分</span></label>
                                        <input type="range" class="form-range" id="estimatedTechnicalValue" min="1" max="10" value="5">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">预估工作量: <span id="effortDisplay">5分</span></label>
                                        <input type="range" class="form-range" id="estimatedEffort" min="1" max="10" value="5">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <strong>预估ROI: <span id="roiDisplay">3.00</span></strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="valueAssessor" class="form-label">价值评估人</label>
                        <input type="text" class="form-control" id="valueAssessor">
                    </div>
                    
                    <div class="mb-3">
                        <label for="otherInfo" class="form-label">其他信息</label>
                        <textarea class="form-control" id="otherInfo" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveRequirementBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- CSV导入模态框 -->
<div class="modal fade" id="csvImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">CSV导入需求</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="csvFile" class="form-label">选择CSV文件</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv">
                    <div class="form-text">
                        请下载 <a href="#" onclick="downloadCSVTemplate()">CSV模板</a> 并按照模板格式填写数据
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">导入选项</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="skipFirstRow" checked>
                        <label class="form-check-label" for="skipFirstRow">
                            跳过第一行（标题行）
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="updateExisting" checked>
                        <label class="form-check-label" for="updateExisting">
                            更新已存在的需求（根据标题匹配）
                        </label>
                    </div>
                </div>
                
                <div id="importPreview" class="d-none">
                    <h6>导入预览</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    <div class="alert alert-info">
                        <small>共 <span id="previewCount">0</span> 条记录待导入</small>
                    </div>
                </div>
                
                <div id="importProgress" class="d-none">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <span id="progressText">处理中...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="startImportBtn" disabled onclick="startCSVImport()">开始导入</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，开始加载需求列表");
    loadRequirements();
    
    // 绑定保存按钮事件
    const saveBtn = document.getElementById('saveRequirementBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveRequirement);
        console.log("保存按钮事件绑定完成");
    } else {
        console.error("未找到保存按钮");
    }
    
    // 绑定滑块事件
    ['estimatedBusinessValue', 'estimatedUserValue', 'estimatedTechnicalValue', 'estimatedEffort'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateValueDisplays);
        }
    });
    
    // 初始化显示
    updateValueDisplays();
});

// 加载需求列表
async function loadRequirements() {
    console.log("开始加载需求列表");
    const tbody = document.getElementById('requirementsBody');
    if (!tbody) {
        console.error("未找到需求列表容器");
        return;
    }
    
    // 显示加载状态
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">加载中...</td></tr>';
    
    try {
        // 添加时间戳防止缓存
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/requirements/{{ project.id }}?t=${timestamp}`, {
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        console.log("API响应状态:", response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const rawData = await response.json();
        console.log('原始响应数据:', rawData);
        console.log('原始响应数据类型:', typeof rawData);
        console.log('是否为数组:', Array.isArray(rawData));
        
        // 修复数据处理逻辑 - 根据API实际返回格式处理
        let requirements = [];
        // 如果返回的是数组，直接使用
        if (Array.isArray(rawData)) {
            requirements = rawData;
        } 
        // 如果返回的是对象且有success字段为false，抛出错误
        else if (rawData && typeof rawData === 'object' && rawData.success === false) {
            throw new Error(rawData.error || 'API返回错误');
        }
        // 如果是其他情况（比如单个需求对象），转换为数组
        else if (rawData && typeof rawData === 'object') {
            requirements = [rawData];
        }
        
        console.log('处理后的需求数据:', requirements);
        console.log('需求数据长度:', requirements.length);
        
        // 渲染数据
        renderRequirements(requirements);
        
    } catch (error) {
        console.error('加载需求失败:', error);
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
    }
}

function renderRequirements(requirements) {
    const tbody = document.getElementById('requirementsBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    console.log('渲染需求数据:', requirements);
    
    if (!requirements || !Array.isArray(requirements) || requirements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无需求数据</td></tr>';
        return;
    }
    
    console.log(`总共 ${requirements.length} 条需求记录`);
    
    requirements.forEach((req, index) => {
        console.log(`需求 ${index + 1}:`, req);
        
        // 确保req是一个对象
        if (typeof req !== 'object' || req === null) {
            console.warn(`需求 ${index + 1} 不是有效对象:`, req);
            return;
        }
        
        const row = document.createElement('tr');
        const createdAt = req.created_at ? new Date(req.created_at).toLocaleDateString() : '-';
        const roi = typeof req.estimated_roi === 'number' ? req.estimated_roi.toFixed(2) : '-';
        
        row.innerHTML = `
            <td>${escapeHtml(req.id || 'N/A')}</td>
            <td>
                <strong>${escapeHtml(req.title || '')}</strong>
            </td>
            <td><span class="badge bg-secondary">${getCategoryText(req.category)}</span></td>
            <td><span class="badge bg-${getPriorityBadgeColor(req.priority)}">${getPriorityText(req.priority)}</span></td>
            <td><span class="badge bg-${getStatusBadgeColor(req.status)}">${getStatusText(req.status)}</span></td>
            <td>${roi}</td>
            <td>${createdAt}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewRequirement(${req.id || 0})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRequirement(${req.id || 0})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // 添加统计信息
    const statsRow = document.createElement('tr');
    statsRow.innerHTML = `<td colspan="8" class="text-end"><strong>总计: ${requirements.length} 条记录</strong></td>`;
    tbody.appendChild(statsRow);
}

function escapeHtml(text) {
    if (typeof text !== 'string') {
        text = String(text || '');
}
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function getCategoryText(category) {
    if (!category) return '-';
    const categories = {
        'functional': '功能',
        'non-functional': '非功能',
        'business': '业务',
        'user': '用户'
    };
    return categories[category] || category;
}

function getPriorityText(priority) {
    if (!priority) return '中';
    const priorities = {
        'high': '高',
        'medium': '中',
        'low': '低'
    };
    return priorities[priority] || priority;
}

function getStatusText(status) {
    if (!status) return '已收集';
    const statuses = {
        'collected': '已收集',
        'analyzing': '分析中',
        'confirmed': '已确认',
        'rejected': '已拒绝',
        'completed': '已完成'
    };
    return statuses[status] || status;
}

function getPriorityBadgeColor(priority) {
    if (!priority) return 'secondary';
    if (priority === 'high') return 'danger';
    if (priority === 'medium') return 'warning';
    if (priority === 'low') return 'success';
    return 'secondary';
}

function getStatusBadgeColor(status) {
    if (!status) return 'info';
    if (status === 'confirmed') return 'success';
    if (status === 'rejected') return 'danger';
    if (status === 'analyzing') return 'warning';
    if (status === 'completed') return 'primary';
    return 'info';
            }
            
// 实时计算和显示ROI
function updateValueDisplays() {
    // 更新滑块显示
    const businessValue = document.getElementById('estimatedBusinessValue');
    const userValue = document.getElementById('estimatedUserValue');
    const technicalValue = document.getElementById('estimatedTechnicalValue');
    const effort = document.getElementById('estimatedEffort');
    
    if (businessValue) document.getElementById('businessValueDisplay').textContent = businessValue.value + '分';
    if (userValue) document.getElementById('userValueDisplay').textContent = userValue.value + '分';
    if (technicalValue) document.getElementById('technicalValueDisplay').textContent = technicalValue.value + '分';
    if (effort) document.getElementById('effortDisplay').textContent = effort.value + '分';
    
    // 计算ROI
    const businessVal = parseInt(businessValue?.value) || 0;
    const userVal = parseInt(userValue?.value) || 0;
    const technicalVal = parseInt(technicalValue?.value) || 0;
    const effortVal = parseInt(effort?.value) || 1; // 避免除零
    
    const totalValue = businessVal + userVal + technicalVal;
    const roi = (totalValue / effortVal).toFixed(2);
    
    const roiDisplay = document.getElementById('roiDisplay');
    if (roiDisplay) roiDisplay.textContent = roi;
}

// 查看需求详情
async function viewRequirement(id) {
    if (!id || id <= 0) return;
    
    try {
        const response = await fetch(`/api/requirements/detail/${id}`);
        const requirement = await response.json();
            
        if (requirement) {
            // 填充模态框数据
            document.getElementById('requirementTitle').value = requirement.title || '';
            document.getElementById('requirementCategory').value = requirement.category || '';
            document.getElementById('requirementSource').value = requirement.source || '';
            document.getElementById('requirementPriority').value = requirement.priority || 'medium';
            document.getElementById('targetUserGroup').value = requirement.target_user_group || '';
            
            // 解析描述内容
            parseDescription(requirement.description || '');
            
            document.getElementById('requirementCriteria').value = requirement.acceptance_criteria || '';
            
            // 填充价值评估数据
            document.getElementById('estimatedBusinessValue').value = requirement.estimated_business_value || 5;
            document.getElementById('estimatedUserValue').value = requirement.estimated_user_value || 5;
            document.getElementById('estimatedTechnicalValue').value = requirement.estimated_technical_value || 5;
            document.getElementById('estimatedEffort').value = requirement.estimated_effort || 5;
            document.getElementById('valueAssessor').value = requirement.value_assessor || '';
            
            // 更新显示
            updateValueDisplays();
            
            // 标记当前为编辑模式
            const modal = document.getElementById('addRequirementModal');
            modal.setAttribute('data-editing-id', id);
            
            // 更改保存按钮行为和样式
            const saveBtn = document.getElementById('saveRequirementBtn');
            saveBtn.onclick = function() {
                updateRequirement(id);
            };
            saveBtn.textContent = '更新需求';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-warning');
            
            // 显示模态框
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }
    } catch (error) {
        console.error('查看需求详情失败:', error);
        alert('加载需求详情失败: ' + error.message);
    }
}

// 解析描述内容并填充到对应字段
function parseDescription(description) {
    if (!description) return;
    
    // 按段落分割
    const sections = description.split('\n\n');
    
    sections.forEach(section => {
        if (section.startsWith('【场景描述】')) {
            document.getElementById('requirementScenario').value = section.replace('【场景描述】', '').trim();
        } else if (section.startsWith('【解决的问题】')) {
            document.getElementById('requirementProblem').value = section.replace('【解决的问题】', '').trim();
        } else if (section.startsWith('【当前解决方案】')) {
            document.getElementById('currentSolution').value = section.replace('【当前解决方案】', '').trim();
        } else if (section.startsWith('【目标】')) {
            document.getElementById('requirementGoal').value = section.replace('【目标】', '').trim();
        } else if (section.startsWith('【预期解决方案】')) {
            document.getElementById('expectedSolution').value = section.replace('【预期解决方案】', '').trim();
        } else if (section.startsWith('【其他信息】')) {
            document.getElementById('otherInfo').value = section.replace('【其他信息】', '').trim();
        }
    });
}

// 保存需求
async function saveRequirement() {
    console.log("开始保存需求");
    
    // 检查是否处于编辑模式
    const modal = document.getElementById('addRequirementModal');
    const editingId = modal.getAttribute('data-editing-id');
    
    // 如果在编辑模式下调用保存函数，应该执行更新操作
    if (editingId) {
        updateRequirement(parseInt(editingId));
        return;
    }
    
    // 收集表单数据（移除description字段）
    const formData = {
        title: document.getElementById('requirementTitle').value.trim(),
        requirement_type: document.getElementById('requirementCategory').value,
        scenario: document.getElementById('requirementScenario').value.trim(),
        problem: document.getElementById('requirementProblem').value.trim(),
        current_solution: document.getElementById('currentSolution').value.trim(),
        goal: document.getElementById('requirementGoal').value.trim(),
        expected_solution: document.getElementById('expectedSolution').value.trim(),
        source: document.getElementById('requirementSource').value,
        category: document.getElementById('requirementCategory').value,
        priority: document.getElementById('requirementPriority').value,
        target_user_group: document.getElementById('targetUserGroup').value.trim(),
        acceptance_criteria: document.getElementById('requirementCriteria').value.trim(),
        estimated_business_value: parseInt(document.getElementById('estimatedBusinessValue').value) || 5,
        estimated_user_value: parseInt(document.getElementById('estimatedUserValue').value) || 5,
        estimated_technical_value: parseInt(document.getElementById('estimatedTechnicalValue').value) || 5,
        estimated_effort: parseInt(document.getElementById('estimatedEffort').value) || 1,
        value_assessor: document.getElementById('valueAssessor').value.trim(),
        other_info: document.getElementById('otherInfo').value.trim()
    };
    
    console.log('准备发送的数据:', formData);
    
    // 验证必要字段
    if (!formData.title || !formData.category || !formData.scenario || !formData.problem || !formData.goal) {
        alert('请填写所有必填字段（标题、类型、场景描述、解决的问题、目标）');
        return;
    }
    
    // 确保工作量不为0
    if (formData.estimated_effort <= 0) {
        formData.estimated_effort = 1;
    }
    
    try {
                            const response = await fetch(`/api/requirements/{{ project.id }}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache',
                'Expires': '0'
                                },
            body: JSON.stringify(formData)
                            });
        
        console.log('服务器响应状态:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
                            
                            const result = await response.json();
        console.log('服务器响应数据:', result);
        
                            if (result.success) {
            // 关闭模态框
            const modalElement = document.getElementById('addRequirementModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                            } else {
                    // 如果没有实例，手动隐藏
                    modalElement.classList.remove('show');
                    modalElement.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
                }
                
            // 清空表单
            document.getElementById('requirementForm').reset();
            
            // 重置滑块显示
            updateValueDisplays();
                
                // 刷新需求列表
                setTimeout(() => {
                    loadRequirements();
            }, 500);
            
            alert('需求添加成功');
        } else {
            const errorMessage = result.error || '未知错误';
            alert('保存失败: ' + errorMessage);
            console.error('保存失败:', errorMessage);
        }
            } catch (error) {
        console.error('保存需求失败:', error);
        alert('保存失败: ' + error.message);
    }
}

// 更新需求
async function updateRequirement(id) {
    // 收集表单数据（移除description字段）
    const formData = {
        title: document.getElementById('requirementTitle').value.trim(),
        requirement_type: document.getElementById('requirementCategory').value,
        scenario: document.getElementById('requirementScenario').value.trim(),
        problem: document.getElementById('requirementProblem').value.trim(),
        current_solution: document.getElementById('currentSolution').value.trim(),
        goal: document.getElementById('requirementGoal').value.trim(),
        expected_solution: document.getElementById('expectedSolution').value.trim(),
        source: document.getElementById('requirementSource').value,
        category: document.getElementById('requirementCategory').value,
        priority: document.getElementById('requirementPriority').value,
        target_user_group: document.getElementById('targetUserGroup').value.trim(),
        acceptance_criteria: document.getElementById('requirementCriteria').value.trim(),
        estimated_business_value: parseInt(document.getElementById('estimatedBusinessValue').value) || 5,
        estimated_user_value: parseInt(document.getElementById('estimatedUserValue').value) || 5,
        estimated_technical_value: parseInt(document.getElementById('estimatedTechnicalValue').value) || 5,
        estimated_effort: parseInt(document.getElementById('estimatedEffort').value) || 1,
        value_assessor: document.getElementById('valueAssessor').value.trim(),
        other_info: document.getElementById('otherInfo').value.trim()
    };
    
    if (!formData.title || !formData.category || !formData.scenario || !formData.problem || !formData.goal) {
        alert('请填写所有必填字段（标题、类型、场景描述、解决的问题、目标）');
        return;
    }
    
    if (formData.estimated_effort <= 0) {
        formData.estimated_effort = 1;
    }
    
    try {
        const response = await fetch(`/api/requirements/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modalElement = document.getElementById('addRequirementModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // 重置表单
            document.getElementById('requirementForm').reset();
            updateValueDisplays();
            
            // 恢复保存按钮
            const saveBtn = document.getElementById('saveRequirementBtn');
            saveBtn.onclick = saveRequirement;
            saveBtn.textContent = '保存';
            saveBtn.classList.remove('btn-warning');
            saveBtn.classList.add('btn-primary');
            
            // 清除编辑状态标记
            const modalEl = document.getElementById('addRequirementModal');
            modalEl.removeAttribute('data-editing-id');
            
            // 刷新列表
            setTimeout(() => {
                loadRequirements();
            }, 500);
            
            alert('需求更新成功');
        } else {
            const errorMessage = result.error || '未知错误';
            alert('更新失败: ' + errorMessage);
        }
    } catch (error) {
        console.error('更新需求失败:', error);
        alert('更新失败: ' + error.message);
    }
}

// 删除需求
async function deleteRequirement(id) {
    if (!id || id <= 0) return;
    
    if (!confirm('确定要删除这个需求吗？此操作无法撤销。')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/requirements/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadRequirements();
            alert('需求删除成功');
        } else {
            alert('删除失败: ' + (result.error || '未知错误'));
        }
    } catch (error) {
        console.error('删除需求失败:', error);
        alert('删除失败: ' + error.message);
    }
}

// 重置模态框状态
document.getElementById('addRequirementModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('requirementForm').reset();
    updateValueDisplays();
    
    // 恢复保存按钮
    const saveBtn = document.getElementById('saveRequirementBtn');
    saveBtn.onclick = saveRequirement;
    saveBtn.textContent = '保存';
    saveBtn.classList.remove('btn-warning');
    saveBtn.classList.add('btn-primary');
    
    // 清除编辑状态标记
    this.removeAttribute('data-editing-id');
});
// 重置模态框状态
document.getElementById('addRequirementModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('requirementForm').reset();
    updateValueDisplays();
    
    // 恢复保存按钮
    const saveBtn = document.getElementById('saveRequirementBtn');
    saveBtn.onclick = saveRequirement;
    saveBtn.textContent = '保存';
    saveBtn.classList.remove('btn-warning');
    saveBtn.classList.add('btn-primary');
    
    // 清除编辑状态标记
    this.removeAttribute('data-editing-id');
});

// CSV导入导出功能
function downloadCSVTemplate() {
    const headers = [
        '标题', '需求类型', '场景描述', '解决的问题', '当前解决方案', 
        '目标', '预期解决方案', '需求来源', '需求类别', '优先级', 
        '目标用户群体', '验收标准', '预估业务价值', '预估用户价值', 
        '预估技术价值', '预估工作量', '价值评估人', '其他信息'
    ];
    
    const csvContent = headers.join(',') + '\n' +
        '示例需求,功能需求,用户在登录页面输入用户名和密码,用户忘记密码无法登录,通过邮箱找回密码,提供便捷的密码重置功能,添加手机验证码重置密码功能,用户反馈,functional,medium,普通用户,用户能够通过手机验证码重置密码,7,8,6,5,张三,这是一个示例需求';
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', '需求导入模板.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportRequirementsCSV() {
    const tbody = document.getElementById('requirementsBody');
    if (!tbody || tbody.children.length === 0) {
        alert('没有需求数据可导出');
        return;
    }
    
    const headers = [
        'ID', '标题', '需求类型', '场景描述', '解决的问题', '当前解决方案',
        '目标', '预期解决方案', '需求来源', '需求类别', '优先级', '状态',
        '目标用户群体', '验收标准', '预估业务价值', '预估用户价值', 
        '预估技术价值', '预估工作量', '预估ROI', '价值评估人', '其他信息'
    ];
    
    let csvContent = headers.join(',') + '\n';
    
    // 获取所有需求行（排除统计行）
    const rows = Array.from(tbody.querySelectorAll('tr')).slice(0, -1);
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
            const rowData = [
                cells[0].textContent.trim(),
                cells[1].textContent.trim(),
                '', // 需求类型
                '', // 场景描述
                '', // 解决的问题
                '', // 当前解决方案
                '', // 目标
                '', // 预期解决方案
                '', // 需求来源
                cells[2].textContent.trim(),
                cells[3].textContent.trim(),
                cells[4].textContent.trim(),
                '', // 目标用户群体
                '', // 验收标准
                '', // 预估业务价值
                '', // 预估用户价值
                '', // 预估技术价值
                '', // 预估工作量
                cells[5].textContent.trim(),
                '', // 价值评估人
                ''  // 其他信息
            ];
            
            // 转义CSV特殊字符
            const escapedData = rowData.map(cell => {
                if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                    return '"' + cell.replace(/"/g, '""') + '"';
                }
                return cell;
            });
            
            csvContent += escapedData.join(',') + '\n';
        }
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `需求导出_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// CSV文件处理
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvData = e.target.result;
            const rows = parseCSV(csvData);
            
            if (rows.length === 0) {
                alert('CSV文件为空或格式不正确');
                return;
            }
            
            // 显示预览
            showImportPreview(rows);
            document.getElementById('startImportBtn').disabled = false;
            
        } catch (error) {
            console.error('CSV解析错误:', error);
            alert('CSV文件解析失败: ' + error.message);
        }
    };
    reader.readAsText(file, 'UTF-8');
});

function parseCSV(csvText) {
    const rows = [];
    const lines = csvText.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const row = [];
        let inQuotes = false;
        let currentField = '';
        
        for (let j = 0; j < line.length; j++) {
            const char = line[j];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                row.push(currentField.trim());
                currentField = '';
            } else {
                currentField += char;
            }
        }
        
        // 添加最后一个字段
        row.push(currentField.trim());
        rows.push(row);
    }
    
    return rows;
}

function showImportPreview(rows) {
    const preview = document.getElementById('importPreview');
    const header = document.getElementById('previewHeader');
    const body = document.getElementById('previewBody');
    const count = document.getElementById('previewCount');
    
    preview.classList.remove('d-none');
    header.innerHTML = '';
    body.innerHTML = '';
    
    // 检查是否跳过第一行
    const skipFirstRow = document.getElementById('skipFirstRow').checked;
    const dataRows = skipFirstRow ? rows.slice(1) : rows;
    
    if (dataRows.length === 0) {
        preview.classList.add('d-none');
        alert('没有有效数据可导入');
        return;
    }
    
    // 创建表头
    const headerRow = document.createElement('tr');
    const firstRow = skipFirstRow ? rows[0] : Array(dataRows[0].length).fill('').map((_, i) => `字段${i + 1}`);
    
    firstRow.forEach(cell => {
        const th = document.createElement('th');
        th.textContent = cell;
        headerRow.appendChild(th);
    });
    header.appendChild(headerRow);
    
    // 创建数据行（最多显示10行预览）
    const previewRows = dataRows.slice(0, 10);
    previewRows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell.length > 50 ? cell.substring(0, 50) + '...' : cell;
            td.title = cell;
            tr.appendChild(td);
        });
        body.appendChild(tr);
    });
    
    count.textContent = dataRows.length;
}

async function startCSVImport() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    if (!file) {
        alert('请先选择CSV文件');
        return;
    }
    
    const skipFirstRow = document.getElementById('skipFirstRow').checked;
    const updateExisting = document.getElementById('updateExisting').checked;
    
    // 显示进度条
    const progress = document.getElementById('importProgress');
    const progressBar = progress.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    progress.classList.remove('d-none');
    
    try {
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const csvData = e.target.result;
                const rows = parseCSV(csvData);
                const dataRows = skipFirstRow ? rows.slice(1) : rows;
                
                if (dataRows.length === 0) {
                    alert('没有有效数据可导入');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    
                    // 更新进度
                    const progressPercent = Math.round((i + 1) / dataRows.length * 100);
                    progressBar.style.width = progressPercent + '%';
                    progressText.textContent = `处理中... ${i + 1}/${dataRows.length}`;
                    
                    try {
                        // 解析CSV行数据
                        const requirementData = parseCSVRow(row);
                        
                        if (requirementData.title) {
                            // 发送到服务器
                            const response = await fetch(`/api/requirements/{{ project.id }}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(requirementData)
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                successCount++;
                            } else {
                                errorCount++;
                                console.error(`导入失败: ${requirementData.title}`, result.error);
                            }
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`处理行 ${i + 1} 时出错:`, error);
                    }
                    
                    // 短暂延迟，避免请求过快
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 完成导入
                progressText.textContent = `导入完成！成功: ${successCount}, 失败: ${errorCount}`;
                progressBar.style.width = '100%';
                progressBar.classList.add('bg-success');
                
                // 刷新需求列表
                setTimeout(() => {
                    loadRequirements();
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('csvImportModal'));
                    if (modal) modal.hide();
                }, 2000);
                
            } catch (error) {
                console.error('导入过程出错:', error);
                progressText.textContent = '导入失败: ' + error.message;
                progressBar.classList.add('bg-danger');
            }
        };
        
        reader.readAsText(file, 'UTF-8');
        
    } catch (error) {
        console.error('导入失败:', error);
        alert('导入失败: ' + error.message);
    }
}

function parseCSVRow(row) {
    // 根据CSV模板映射字段
    return {
        title: row[0] || '',
        requirement_type: row[1] || 'functional',
        scenario: row[2] || '',
        problem: row[3] || '',
        current_solution: row[4] || '',
        goal: row[5] || '',
        expected_solution: row[6] || '',
        source: row[7] || '',
        category: row[8] || 'functional',
        priority: row[9] || 'medium',
        target_user_group: row[10] || '',
        acceptance_criteria: row[11] || '',
        estimated_business_value: parseInt(row[12]) || 5,
        estimated_user_value: parseInt(row[13]) || 5,
        estimated_technical_value: parseInt(row[14]) || 5,
        estimated_effort: parseInt(row[15]) || 5,
        value_assessor: row[16] || '',
        other_info: row[17] || ''
    };
}

// 重置CSV导入模态框
document.getElementById('csvImportModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('csvFile').value = '';
    document.getElementById('importPreview').classList.add('d-none');
    document.getElementById('importProgress').classList.add('d-none');
    document.getElementById('startImportBtn').disabled = true;
    
    // 重置进度条
    const progressBar = document.getElementById('importProgress').querySelector('.progress-bar');
    progressBar.style.width = '0%';
    progressBar.classList.remove('bg-success', 'bg-danger');
});
</script>

{% endblock %}
